# Alembic Migration Best Practices for ABParts

## Common Issues We've Encountered

### 1. ❌ Revision ID Too Long
**Problem:** `alembic_version.version_num` column is VARCHAR(32)  
**Error:** `value too long for type character varying(32)`

**Solution:** Keep revision IDs ≤ 32 characters

```python
# ❌ BAD - 37 characters
revision = '20241130_redesign_stock_adjustments'

# ✅ GOOD - 19 characters
revision = '20241130_stock_adj'
```

### 2. ❌ Wrong down_revision Reference
**Problem:** Using filename instead of actual revision ID  
**Error:** `KeyError: '20251124_add_customer_order_id_to_transactions'`

**Solution:** Always check the actual revision ID in the file

```python
# Check the previous migration file for its revision ID
# File: 20251124_add_customer_order_id_to_transactions.py
revision = '20251124_order_txn'  # ← Use THIS

# In your new migration:
down_revision = '20251124_order_txn'  # ✅ CORRECT
down_revision = '20251124_add_customer_order_id_to_transactions'  # ❌ WRONG
```

### 3. ❌ Multiple Heads (Branched History)
**Problem:** Multiple migration branches exist  
**Error:** `Multiple head revisions are present`

**Solution:** Create a merge migration

```python
# Create merge migration
revision = '20241130_merge'
down_revision = ('branch1_revision', 'branch2_revision')  # Tuple of both heads
```

## Migration Creation Checklist

Use this checklist EVERY time you create a migration:

### Before Creating Migration

- [ ] Check current migration status: `docker-compose exec api alembic current`
- [ ] Check for multiple heads: `docker-compose exec api alembic heads`
- [ ] If multiple heads exist, create merge migration first
- [ ] Identify the correct down_revision by checking the latest migration file

### Creating the Migration File

- [ ] Use descriptive but SHORT filename: `YYYYMMDD_short_description.py`
- [ ] Set revision ID ≤ 32 characters (count them!)
- [ ] Use actual revision ID for down_revision (not filename)
- [ ] Add clear docstring explaining what the migration does
- [ ] Include both upgrade() and downgrade() functions

### Migration File Template

```python
"""brief description of changes

Revision ID: YYYYMMDD_short_name  # ≤ 32 chars!
Revises: previous_revision_id      # Check the actual ID!
Create Date: YYYY-MM-DD HH:MM:SS

Detailed description of what this migration does:
- Change 1
- Change 2
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'YYYYMMDD_short_name'  # ≤ 32 characters!
down_revision = 'previous_revision_id'  # From previous file's revision variable
branch_labels = None
depends_on = None


def upgrade():
    """Apply the migration."""
    # Your changes here
    pass


def downgrade():
    """Revert the migration."""
    # Reverse your changes here
    pass
```

### Testing the Migration

- [ ] Test locally first: `docker-compose exec api alembic upgrade head`
- [ ] Check for errors in output
- [ ] Verify database changes: `docker-compose exec db psql -U abparts_user -d abparts_dev -c "\d table_name"`
- [ ] Test downgrade: `docker-compose exec api alembic downgrade -1`
- [ ] Test upgrade again: `docker-compose exec api alembic upgrade head`
- [ ] Verify application still works

### After Migration Success

- [ ] Document any manual steps needed
- [ ] Update models.py if schema changed
- [ ] Update schemas.py if needed
- [ ] Commit migration file with clear message
- [ ] Test in production-like environment before deploying

## Quick Reference Commands

### Check Migration Status
```bash
# Current version
docker-compose exec api alembic current

# All heads (should be 1)
docker-compose exec api alembic heads

# Show branches
docker-compose exec api alembic branches

# Show history
docker-compose exec api alembic history
```

### Run Migrations
```bash
# Upgrade to latest
docker-compose exec api alembic upgrade head

# Upgrade one step
docker-compose exec api alembic upgrade +1

# Downgrade one step
docker-compose exec api alembic downgrade -1

# Downgrade to specific revision
docker-compose exec api alembic downgrade <revision_id>
```

### Create Migrations
```bash
# Auto-generate from model changes
docker-compose exec api alembic revision --autogenerate -m "description"

# Create empty migration
docker-compose exec api alembic revision -m "description"

# Create merge migration (when multiple heads)
docker-compose exec api alembic merge -m "merge heads" head1 head2
```

## Naming Conventions

### Revision IDs (≤ 32 chars)
```
✅ GOOD:
- 20241130_add_col        (18 chars)
- 20241130_stock_adj      (19 chars)
- 20241130_merge          (15 chars)
- abc123def456            (12 chars - autogenerated)

❌ BAD:
- 20241130_redesign_stock_adjustments_system  (45 chars - TOO LONG!)
- add_customer_order_id_to_transactions       (39 chars - TOO LONG!)
```

### File Names
```
✅ GOOD:
- 20241130_add_stock_adjustment_items.py
- 20241130_merge_heads.py
- 20241201_add_user_preferences.py

❌ BAD:
- migration.py
- fix.py
- update_20241130.py
```

## Common Migration Patterns

### Adding a Column
```python
def upgrade():
    op.add_column('table_name',
        sa.Column('new_column', sa.String(255), nullable=True)
    )

def downgrade():
    op.drop_column('table_name', 'new_column')
```

### Creating a Table
```python
def upgrade():
    op.create_table(
        'new_table',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('name', sa.String(255), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.func.now())
    )

def downgrade():
    op.drop_table('new_table')
```

### Adding an Enum
```python
def upgrade():
    # Create enum type
    enum_type = postgresql.ENUM('value1', 'value2', name='myenum', create_type=False)
    enum_type.create(op.get_bind(), checkfirst=True)
    
    # Add column using enum
    op.add_column('table_name',
        sa.Column('status', enum_type, nullable=False, server_default='value1')
    )

def downgrade():
    op.drop_column('table_name', 'status')
    op.execute('DROP TYPE IF EXISTS myenum;')
```

### Modifying a Column
```python
def upgrade():
    op.alter_column('table_name', 'column_name',
        type_=sa.String(500),  # Change type
        nullable=False,         # Change nullable
        server_default='default'  # Change default
    )

def downgrade():
    op.alter_column('table_name', 'column_name',
        type_=sa.String(255),
        nullable=True,
        server_default=None
    )
```

## Troubleshooting

### Issue: "Multiple head revisions"
```bash
# 1. Check heads
docker-compose exec api alembic heads

# 2. Create merge migration
docker-compose exec api alembic merge -m "merge" head1 head2

# 3. Edit the generated file to ensure revision ID ≤ 32 chars

# 4. Run migration
docker-compose exec api alembic upgrade head
```

### Issue: "Revision X not found"
```bash
# 1. Check what's in the database
docker-compose exec db psql -U abparts_user -d abparts_dev -c "SELECT * FROM alembic_version;"

# 2. Check what files exist
ls backend/alembic/versions/

# 3. Fix down_revision in your migration file to match actual revision ID
```

### Issue: Migration fails halfway
```bash
# 1. Check current state
docker-compose exec api alembic current

# 2. Manually fix database if needed
docker-compose exec db psql -U abparts_user -d abparts_dev

# 3. Mark migration as complete (if you fixed manually)
docker-compose exec api alembic stamp head

# 4. Or downgrade and try again
docker-compose exec api alembic downgrade -1
```

## Pre-Migration Script

Create this script to check everything before creating a migration:

```bash
#!/bin/bash
# pre_migration_check.sh

echo "=== Pre-Migration Checklist ==="
echo ""

echo "1. Current migration:"
docker-compose exec api alembic current
echo ""

echo "2. Number of heads (should be 1):"
HEAD_COUNT=$(docker-compose exec api alembic heads 2>/dev/null | grep -c "^[a-f0-9]")
if [ "$HEAD_COUNT" -eq 1 ]; then
    echo "✅ Single head - OK"
else
    echo "⚠️  Multiple heads detected - create merge migration first!"
fi
echo ""

echo "3. Latest migration file:"
ls -t backend/alembic/versions/*.py | head -1
echo ""

echo "4. Latest revision ID:"
LATEST_FILE=$(ls -t backend/alembic/versions/*.py | head -1)
grep "^revision = " "$LATEST_FILE"
echo ""

echo "Ready to create migration? (y/n)"
```

## Post-Migration Script

```bash
#!/bin/bash
# post_migration_check.sh

echo "=== Post-Migration Verification ==="
echo ""

echo "1. Migration applied:"
docker-compose exec api alembic current
echo ""

echo "2. Check for errors:"
docker-compose logs api | tail -20
echo ""

echo "3. Verify database:"
echo "Run: docker-compose exec db psql -U abparts_user -d abparts_dev"
echo "Then: \d table_name"
echo ""

echo "4. Test application:"
echo "Visit: http://localhost:3000"
```

## Summary: The Golden Rules

1. **Revision ID ≤ 32 characters** - Always count!
2. **Use actual revision ID** - Not the filename
3. **Check for multiple heads** - Merge before creating new migrations
4. **Test locally first** - Never run untested migrations in production
5. **Write downgrade()** - Always be able to rollback
6. **Document changes** - Clear docstrings and comments
7. **One logical change** - Don't mix unrelated changes
8. **Backup before production** - Always have a way back

---

**Remember:** Migrations are permanent changes to production data. Take your time, test thoroughly, and follow the checklist!
