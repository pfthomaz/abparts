# Offline Mode Not Working - Fix

## Problem
The offline mode isn't working because the custom service worker (`service-worker.js`) isn't being properly included in the production build.

## Root Cause
Create React App's build process doesn't automatically copy custom service workers from `public/` to the build output in a way that allows them to be registered.

## Solution

### Option 1: Use Workbox (Recommended)
Workbox is already installed. We need to configure it properly.

1. Create `src/service-worker.js` (move from public to src):
```bash
mv frontend/public/service-worker.js frontend/src/service-worker.js
```

2. Update `src/service-worker.js` to use Workbox:
```javascript
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { StaleWhileRevalidate, NetworkFirst, CacheFirst } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';

// Precache all assets generated by the build process
precacheAndRoute(self.__WB_MANIFEST);

// Cache API responses
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/'),
  new NetworkFirst({
    cacheName: 'api-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 5 * 60, // 5 minutes
      }),
    ],
  })
);

// Cache images
registerRoute(
  ({ request }) => request.destination === 'image',
  new CacheFirst({
    cacheName: 'images',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 60,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 Days
      }),
    ],
  })
);
```

3. Build the app - Workbox will automatically inject the service worker

### Option 2: Quick Fix - Copy Service Worker Post-Build

Add a post-build script to copy the service worker:

1. Create `frontend/copy-sw.js`:
```javascript
const fs = require('fs');
const path = require('path');

const source = path.join(__dirname, 'public', 'service-worker.js');
const dest = path.join(__dirname, 'build', 'service-worker.js');

fs.copyFileSync(source, dest);
console.log('✓ Service worker copied to build folder');
```

2. Update `frontend/package.json` scripts:
```json
{
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build && node copy-sw.js",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  }
}
```

### Option 3: Manual Copy (Temporary Fix)

For immediate testing:

**Local:**
```bash
# After building
cp frontend/public/service-worker.js frontend/build/service-worker.js
```

**Production (in Docker):**
```bash
# Copy service worker into the running container
docker compose exec web cp /app/public/service-worker.js /usr/share/nginx/html/service-worker.js
```

## Testing Offline Mode

1. **Check Service Worker Registration:**
   Open browser console and run:
   ```javascript
   navigator.serviceWorker.getRegistrations().then(r => console.log('Registered:', r.length > 0))
   ```

2. **Check IndexedDB:**
   Open DevTools > Application > IndexedDB
   Should see: `ABPartsOfflineDB`

3. **Test Offline:**
   - Open DevTools > Network tab
   - Set throttling to "Offline"
   - Try to create a maintenance execution or net cleaning record
   - Should save locally and show in pending sync

4. **Test Sync:**
   - Go back online
   - Data should automatically sync
   - Check console for sync messages

## Quick Diagnostic

Run:
```bash
chmod +x diagnose_offline_mode.sh
./diagnose_offline_mode.sh
```

## Immediate Action

Choose Option 2 (post-build script) as it's the quickest proper fix:

```bash
# Create the copy script
cat > frontend/copy-sw.js << 'EOF'
const fs = require('fs');
const path = require('path');

const source = path.join(__dirname, 'public', 'service-worker.js');
const dest = path.join(__dirname, 'build', 'service-worker.js');

if (fs.existsSync(source)) {
  fs.copyFileSync(source, dest);
  console.log('✓ Service worker copied to build folder');
} else {
  console.warn('⚠ Service worker source file not found');
}
EOF

# Update package.json (backup first)
cp frontend/package.json frontend/package.json.backup

# Rebuild
cd frontend && npm run build
```

Then restart the containers to pick up the new build.
